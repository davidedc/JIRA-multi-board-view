<html>
<body>

<script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="http://cdnjs.cloudflare.com/ajax/libs/coffee-script/1.7.1/coffee-script.min.js"></script>


<script type="text/coffeescript">


#
$("input[name='epicgroup']").change ->
  selectedCheckbox = $("input[name='epicgroup']:checked").val()
  if selectedCheckbox is "1"
  	console.log "selected checkbox 1"
  	makeRequestAndUpdateBoard(selectedCheckbox, '"Epic Link" = SRM-488 or "Epic Link" = SRM-499 or "Epic Link" = SRM-537')
  else if selectedCheckbox is "2"
  	console.log "selected checkbox 2"
  	makeRequestAndUpdateBoard(selectedCheckbox, '"Epic Link" = SRM-567 or "Epic Link" = SRM-568 or "Epic Link" = SRM-536 or "Epic Link" = SRM-570')
  else if selectedCheckbox is "4"
  	console.log "selected checkbox 4"
  	makeRequestAndUpdateBoard(selectedCheckbox, '"Epic Link" = SRM-291 or "Epic Link" = SRM-313')
  else if selectedCheckbox is "5"
  	console.log "selected checkbox 5"
  	makeRequestAndUpdateBoard(selectedCheckbox, '"Epic Link" = SRM-491 or "Epic Link" = SRM-506')
  else if selectedCheckbox is "6"
  	console.log "selected checkbox 6"
  	makeRequestAndUpdateBoard(selectedCheckbox, '"Epic Link" = SRM-463')
  else if selectedCheckbox is "7"
  	console.log "selected checkbox 7"
  	makeRequestAndUpdateBoard(selectedCheckbox, '"Epic Link" = SRM-588 or "Epic Link" = SRM-586 or "Epic Link" = SRM-587')
  else if selectedCheckbox is "8"
  	console.log "selected checkbox 8"
  	makeRequestAndUpdateBoard(selectedCheckbox, '"Epic Link" = SRM-591 or "Epic Link" = SRM-592')
  return


# we gonna have several boards, we are
# gonna put the project ID for each board in here
boardNames = []

# We are going to show the equivalent of a JIRA
# board. Just like JIRA boards, each column can
# group several statuses, so we model that in this array.

groupedStatuses = []


boardNames.push 'SIO'
groupedStatuses.push [
	["Open"], # column 1
	["Prioritised"], # column 2
	["In Development"], # ...
	["In Testing"],
	["Fix soon"],
	["Resolved", "Closed"]
]

boardNames.push 'SOA'
groupedStatuses.push [
	["Await Tech lead approval"], # column 1
	["Awaiting Development"], # column 2
	["In Development"], # ...
	["Awaiting Testing"],
	["In Testing"],
	["Fix soon"],
	["UAT"],
	["Resolved", "Closed"]
]

boardNames.push 'AMP'
groupedStatuses.push [
	["Awaiting Review", "Work Blocked"], # column 1
	["Open", "Reopened"], # column 2
	["Awaiting Development"], # ...
	["In Progress"],
	["Awaiting Testing", "In Testing", "Testing Blocked]"],
	["Resolved"]
]

boardNames.push 'WPS'
groupedStatuses.push [
	["Await Tech lead approval"], # column 1
	["Awaiting Development", "Open", "Prioritised"], # column 2
	["In Development", "In Progress"], # ...
	["In Progress"],
	["Available for code review"],
	["Code Review"],
	["Travelling to Beta"],
	["Awaiting Testing"],
	["In Testing"],
	["Awaiting Triage"],
	["Fix soon"],
	["UAT"],
	["Resolved", "Closed"]	
]

boardNames.push 'SSP'
groupedStatuses.push [
	["Committed items"], # column 1
	["Work Blocked"], # column 2
	["In Progress"], # ...
	["Resolved"]	
]


buildBoards = ->
	for boardNumber in [0...boardNames.length]
		theBoardName = boardNames[boardNumber]
		console.log "adding board " + theBoardName
		$( "#boards").append '<div id="board'+theBoardName+'" style="float: left; overflow: hidden; font-size:8px; border: 1px dotted; margin: 3px;"> <div style = "background-color: #E0FFFF;">' + theBoardName + '</div> </br> </div>'
		for columnNumber in [1...10]
			console.log "adding column " + columnNumber + " to board " + theBoardName
			$( "#board" + theBoardName).append '<div id="board'+theBoardName+'column'+columnNumber+'"  style="float: left; width:50px;"> </div>'

clearBoards = ->
	$( "#boards").empty()
	$( "#details").empty()


makeRequestAndUpdateBoard = (epicGroupNumber, searchQuery) ->

	$.ajax
		type: 'GET',
		url: './search/something.json',
		dataType: 'jsonp',
		data: {'epicGroupNumber': epicGroupNumber, 'search':searchQuery},
		success: (responseObject) ->
			# debugger;
			
			clearBoards()
			buildBoards()
			
			console.log JSON.stringify responseObject

			window.openInFrame = (theIssueKey) ->
				$('#JIRAIframe').empty()
				$('#JIRAIframe').append("<iframe width='100%' height='800' src='https://jira.shazamteam.net/browse/"+theIssueKey+"'></iframe>")

			for boardNumber in [0...boardNames.length]
				# add the header in each column, in bold
				# telling which statuses are grouped in it
				groupNumber = 0
				for statusGroup in groupedStatuses[boardNumber]
					groupNumber++
					header = ""
					for eachStatus in statusGroup
						header = header + eachStatus + " "
					$( "#board" + boardNames[boardNumber] + "column" + groupNumber ).append( "<b>" + header + "<b>" )

				# now add the issues in each column.
				# for each issue in the result set, scan whether
				# it belongs to the board, which group it
				# belongs to, according to status, and
				# place in the correct column.
				# DEFINITELY not the most efficient way
				# as we scan each issue as many times
				# as there is a board.
				# The good news is that would work also
				# in case where the same issue would appear in more
				# than one board.
				# but it's not like we need to place hundreds
				# of issues here, so it's OK
				for i in responseObject.result
					console.log i
					project = i[1].substring(0, 3)
					console.log "project: " + project
					if project != boardNames[boardNumber]
						continue;

					groupNumber = 0
					for statusGroup in groupedStatuses[boardNumber]
						groupNumber++
						if i[3] in statusGroup
							# the javascript is just to have the issue details to open
							# in a dedicated div to the right, cause the tiles are
							# probably gonna get real small as we fit more boards
							# in the page

							issueKey = i[1]
							console.log issueKey
							onClickCode = "onclick= \"openInFrame('"+issueKey+"');\""
							#console.log onClickCode

							$( "#board" + boardNames[boardNumber] + "column" + groupNumber ).append( "<div onmouseover=\"$('#details').text( $(this).text() );\" " + onClickCode + " style='cursor: pointer; background-color: #DCDCDC; padding: 3px; margin: 3px;'>"  + i[1]  + '<div style="font-size:2px" >' + i[2] + "</div> </div> " )



</script>

Pick an epic group:
</br>
<form action="">
<input type="radio" name="epicgroup" value="1">ho scr<br>
<input type="radio" name="epicgroup" value="2">con aw<br>
<input type="radio" name="epicgroup" value="4">int rd<br>
<input type="radio" name="epicgroup" value="5">int sp<br>
<input type="radio" name="epicgroup" value="6">sea ap<br>
<input type="radio" name="epicgroup" value="7">itu ing<br>
<input type="radio" name="epicgroup" value="8">sir<br>
</form>
</br>

<hr>

<div id="boards">
</div>

<div id="details" style="float: left; width:100px; position:absolute ; right: 10%;"> </div>

</br>

<div id="JIRAIframe" style="width:90%">
</div>

</body>
</html>
